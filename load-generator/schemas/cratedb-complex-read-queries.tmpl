{{define "MostFrequentPOIToPOITrips"}}
SELECT start_poi.poi_id AS start_poi, end_poi.poi_id AS end_poi, COUNT(*) AS trip_count
FROM (
  SELECT trip_id,
         MIN(timestamp) AS start_time,
         MAX(timestamp) AS end_time
  FROM escooter_events
  WHERE timestamp BETWEEN '{{.StartTime}}' AND '{{.EndTime}}'
  GROUP BY trip_id
) t
JOIN escooter_events e_start ON e_start.trip_id = t.trip_id AND e_start.timestamp = t.start_time
JOIN escooter_events e_end ON e_end.trip_id = t.trip_id AND e_end.timestamp = t.end_time
JOIN pois start_poi ON distance(e_start.geo_point, start_poi.geo_point) < {{.Radius}}
JOIN pois end_poi ON distance(e_end.geo_point, end_poi.geo_point) < {{.Radius}}
GROUP BY start_poi.poi_id, end_poi.poi_id
ORDER BY trip_count DESC
{{end}}

{{define "EventDensityHeatmapPerDistrict"}}
SELECT d.name AS district,
       DATE_BIN(INTERVAL '1 hour', e.timestamp, TIMESTAMP '2000-01-01 00:00:00+00:00') AS hour,
       COUNT(*) AS event_count
FROM escooter_events e
JOIN districts d ON within(e.geo_point, d.geo_shape)
WHERE e.timestamp BETWEEN '{{.StartTime}}' AND '{{.EndTime}}'
GROUP BY d.name, hour
ORDER BY d.name, hour
{{end}}

{{define "TripDurationsPerDistrict"}}
SELECT d.name AS district,
       AVG(duration_secs) AS avg_duration_secs
FROM (
  SELECT trip_id,
         EXTRACT(EPOCH FROM (MAX(timestamp) - MIN(timestamp))) AS duration_secs
  FROM escooter_events
  WHERE timestamp BETWEEN '{{.StartTime}}' AND '{{.EndTime}}'
  GROUP BY trip_id
  HAVING EXTRACT(EPOCH FROM (MAX(timestamp) - MIN(timestamp))) > 60
) trip_durations
JOIN escooter_events e ON e.trip_id = trip_durations.trip_id
JOIN districts d ON within(e.geo_point, d.geo_shape)
WHERE e.timestamp BETWEEN '{{.StartTime}}' AND '{{.EndTime}}'
GROUP BY d.name
ORDER BY avg_duration_secs DESC
{{end}}

{{define "MostVisitedPOIs"}}
SELECT p.poi_id, p.name, COUNT(*) AS visits
FROM escooter_events e
JOIN pois p ON distance(e.geo_point, p.geo_point) < {{.Radius}}
WHERE e.timestamp BETWEEN '{{.StartTime}}' AND '{{.EndTime}}'
GROUP BY p.poi_id, p.name
ORDER BY visits DESC
{{end}}

{{define "OriginDestinationMatrix"}}
SELECT d_start.name AS origin,
       d_end.name AS destination,
       COUNT(*) AS trip_count
FROM (
  SELECT trip_id,
         MIN(timestamp) AS start_time,
         MAX(timestamp) AS end_time
  FROM escooter_events
  WHERE timestamp BETWEEN '{{.StartTime}}' AND '{{.EndTime}}'
  GROUP BY trip_id
) trips
JOIN escooter_events e_start ON e_start.trip_id = trips.trip_id AND e_start.timestamp = trips.start_time
JOIN escooter_events e_end ON e_end.trip_id = trips.trip_id AND e_end.timestamp = trips.end_time
JOIN districts d_start ON within(e_start.geo_point, d_start.geo_shape)
JOIN districts d_end ON within(e_end.geo_point, d_end.geo_shape)
GROUP BY d_start.name, d_end.name
ORDER BY trip_count DESC
{{end}}

{{define "CountEventsInDistrictPerHour"}}
SELECT
    DATE_BIN(INTERVAL '1 hour', e.timestamp, TIMESTAMP '2000-01-01 00:00:00+00:00') AS hour,
    COUNT(*) AS event_count
FROM escooter_events e
JOIN districts d
  ON within(e.geo_point, d.geo_shape)
WHERE d.name = '{{.DistrictName}}'
  AND e.timestamp BETWEEN '{{.StartTime}}' AND '{{.EndTime}}'
GROUP BY hour
ORDER BY hour
{{end}}

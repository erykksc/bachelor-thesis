-- Trip events (equivalent to GetTripEvents)
{{define "GetTripEvents"}}
SELECT geo_point, timestamp AS instant
FROM escooter_events
WHERE trip_id = '{{.TripID}}'
ORDER BY timestamp;
{{end}}

-- Start and end timestamp of a trip (equivalent to TripFirstAndLastEvent)
{{define "TripFirstAndLastEvent"}}
SELECT MIN(timestamp) AS start_time, MAX(timestamp) AS end_time
FROM escooter_events
WHERE trip_id = '{{.TripID}}';
{{end}}

-- Length of a trip (equivalent to LengthOfTrip)
{{define "LengthOfTrip"}}
SELECT SUM(distance(geo_point, next_geo)) AS tripLengthInMeters
FROM (
  SELECT
    geo_point,
    LEAD(geo_point) OVER (ORDER BY timestamp) AS next_geo
  FROM escooter_events
  WHERE trip_id = '{{.TripID}}'
) t
WHERE next_geo IS NOT NULL;
{{end}}

-- Average speed of trip in Km/h (equivalent to AverageSpeedOfTrip) - optimized version
{{define "AverageSpeedOfTrip"}}
WITH trip_points AS (
  SELECT timestamp, geo_point,
         LEAD(geo_point) OVER (ORDER BY timestamp) AS next_geo,
         LEAD(timestamp) OVER (ORDER BY timestamp) AS next_timestamp
  FROM escooter_events
  WHERE trip_id = '{{.TripID}}'
),
speed_segments AS (
  SELECT 
    distance(geo_point, next_geo) AS segment_distance,
    EXTRACT(EPOCH FROM (next_timestamp - timestamp)) AS segment_time
  FROM trip_points
  WHERE next_geo IS NOT NULL AND next_timestamp IS NOT NULL
)
SELECT 
  CASE 
    WHEN SUM(segment_time) > 0 
    THEN (SUM(segment_distance) / SUM(segment_time)) * 3.6 
    ELSE 0 
  END AS avgSpeedInKmh
FROM speed_segments;
{{end}}

-- POIs within radius of the trip trajectory (equivalent to PoisWithinRadiusDuringTrip)
{{define "PoisWithinRadiusDuringTrip"}}
SELECT DISTINCT p.*
FROM escooter_events e
JOIN pois p
  ON distance(e.geo_point, p.geo_point) <= {{.Radius}}
WHERE e.trip_id = '{{.TripID}}';
{{end}}

-- Trip's start locality (equivalent to TripStartingLocality) - optimized with LIMIT
{{define "TripStartingLocality"}}
SELECT '{{.TripID}}' AS trip_id, d.name AS start_locality
FROM (
  SELECT geo_point
  FROM escooter_events
  WHERE trip_id = '{{.TripID}}'
  ORDER BY timestamp
  LIMIT 1
) e
JOIN localities d
  ON within(e.geo_point, d.geo_shape);
{{end}}

-- Trip's end locality (equivalent to TripEndLocality) - optimized with LIMIT
{{define "TripEndLocality"}}
SELECT '{{.TripID}}' AS trip_id, d.name AS end_locality
FROM (
  SELECT geo_point
  FROM escooter_events
  WHERE trip_id = '{{.TripID}}'
  ORDER BY timestamp DESC
  LIMIT 1
) e
JOIN localities d
  ON within(e.geo_point, d.geo_shape);
{{end}}

-- POIs close to the end of a trip (equivalent to PoisCloseToEndDestination)
{{define "PoisCloseToEndDestination"}}
SELECT p.poi_id, p.name, distance(p.geo_point, e.geo_point) AS distance
FROM (
  SELECT geo_point
  FROM escooter_events
  WHERE trip_id = '{{.TripID}}'
  ORDER BY timestamp DESC
  LIMIT 1
) e
CROSS JOIN pois p
ORDER BY distance ASC
LIMIT {{.Limit}};
{{end}}

